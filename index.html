<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>St. James: Ultra Realism + Sound</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Inter', sans-serif; }
        #overlay { position: absolute; bottom: 30px; left: 30px; }
        #joy-base {
            width: 100px; height: 100px; background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2); border-radius: 50%;
            backdrop-filter: blur(10px); position: relative;
        }
        #joy-stick {
            width: 40px; height: 40px; background: #fff; border-radius: 50%;
            position: absolute; top: 30px; left: 30px;
        }
        #hint { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; text-align: center; pointer-events: none; opacity: 0.8; }
    </style>
</head>
<body>

<div id="hint" id="start-hint">Нажмите на экран для звука и управления</div>
<div id="overlay"><div id="joy-base"><div id="joy-stick"></div></div></div>

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
</script>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { Water } from 'three/addons/objects/Water.js';

    let scene, camera, renderer, water, controls, clock;
    let moveForward = 0, moveSide = 0;
    let audioContext, seaSound, stepSound;

    init();

    async function init() {
        scene = new THREE.Scene();
        clock = new THREE.Clock();

        camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 2000);
        camera.position.set(40, 5, 40);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // Свет
        const sun = new THREE.DirectionalLight(0xffffff, 2);
        sun.position.set(50, 50, 50);
        sun.castShadow = true;
        scene.add(sun);
        scene.add(new THREE.AmbientLight(0x404040, 1));

        // Вода
        const waterGeo = new THREE.PlaneGeometry(2000, 2000);
        water = new Water(waterGeo, {
            textureWidth: 512, textureHeight: 512,
            waterNormals: new THREE.TextureLoader().load('https://threejs.org/examples/textures/waternormals.jpg', t => t.wrapS = t.wrapT = THREE.RepeatWrapping),
            sunDirection: sun.position.clone().normalize(),
            sunColor: 0xffffff,
            waterColor: 0x004d4d,
            distortionScale: 3.7,
        });
        water.rotation.x = -Math.PI / 2;
        scene.add(water);

        // Остров (Ландшафт)
        const islandGeo = new THREE.CylinderGeometry(50, 55, 4, 64);
        const islandMat = new THREE.MeshStandardMaterial({ color: 0xedc9af });
        const island = new THREE.Mesh(islandGeo, islandMat);
        island.position.y = -1.5;
        island.receiveShadow = true;
        scene.add(island);

        // Растительность (Пальмы)
        for(let i = 0; i < 15; i++) {
            createPalm(
                Math.random() * 60 - 30, 
                Math.random() * 60 - 30
            );
        }

        // Храм
        createTemple();

        // Управление
        controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        setupJoystick();

        // Звуковая инициализация по клику
        window.addEventListener('click', initAudio, { once: true });

        animate();
    }

    function createPalm(x, z) {
        if(Math.abs(x) < 10 && Math.abs(z) < 10) return; // Не спавнить в здании
        const group = new THREE.Group();
        const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.4, 6), new THREE.MeshStandardMaterial({color: 0x654321}));
        trunk.position.y = 3;
        group.add(trunk);
        
        for(let i = 0; i < 5; i++) {
            const leaf = new THREE.Mesh(new THREE.SphereGeometry(2, 8, 2), new THREE.MeshStandardMaterial({color: 0x228b22}));
            leaf.scale.set(1.5, 0.1, 0.5);
            leaf.position.y = 6;
            leaf.rotation.y = (i * Math.PI * 2) / 5;
            group.add(leaf);
        }
        group.position.set(x, 0, z);
        scene.add(group);
    }

    function createTemple() {
        const temple = new THREE.Group();
        for(let i = 0; i < 20; i++) {
            const stripe = new THREE.Mesh(
                new THREE.BoxGeometry(10, 0.3, 10),
                new THREE.MeshStandardMaterial({ color: i % 2 === 0 ? 0xffffff : 0x0033cc })
            );
            stripe.position.y = i * 0.3;
            stripe.castShadow = true;
            temple.add(stripe);
        }
        const dome = new THREE.Mesh(new THREE.SphereGeometry(4, 32, 16, 0, Math.PI*2, 0, Math.PI/2), new THREE.MeshStandardMaterial({color: 0xffd700, metalness: 1}));
        dome.position.y = 6;
        temple.add(dome);
        scene.add(temple);
    }

    function initAudio() {
        document.getElementById('hint').style.display = 'none';
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // Море (Белый шум с фильтром)
        const bufferSize = 2 * audioContext.sampleRate;
        const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
        const output = noiseBuffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) output[i] = Math.random() * 2 - 1;

        const noise = audioContext.createBufferSource();
        noise.buffer = noiseBuffer;
        noise.loop = true;
        
        const filter = audioContext.createBiquadFilter();
        filter.type = 'lowpass';
        filter.frequency.value = 400;

        const gainSea = audioContext.createGain();
        gainSea.gain.value = 0.2;

        noise.connect(filter).connect(gainSea).connect(audioContext.destination);
        noise.start();
    }

    function animate() {
        requestAnimationFrame(animate);
        const delta = clock.getDelta();

        // Движение
        const dir = new THREE.Vector3();
        camera.getWorldDirection(dir);
        dir.y = 0; dir.normalize();
        const side = new THREE.Vector3().crossVectors(camera.up, dir).normalize();

        if(moveForward || moveSide) {
            camera.position.addScaledVector(dir, moveForward * 0.3);
            camera.position.addScaledVector(side, moveSide * 0.3);
            // Тут можно добавить триггер звука шагов
        }

        water.material.uniforms['time'].value += delta;
        controls.update();
        renderer.render(scene, camera);
    }

    function setupJoystick() {
        const base = document.getElementById('joy-base');
        const stick = document.getElementById('joy-stick');
        base.addEventListener('touchmove', (e) => {
            const t = e.touches[0];
            const r = base.getBoundingClientRect();
            const x = t.clientX - (r.left + 50), y = t.clientY - (r.top + 50);
            const d = Math.min(Math.sqrt(x*x+y*y), 40);
            const a = Math.atan2(y, x);
            stick.style.transform = `translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
            moveSide = Math.cos(a) * (d/40);
            moveForward = -Math.sin(a) * (d/40);
        });
        base.addEventListener('touchend', () => {
            stick.style.transform = 'none';
            moveForward = moveSide = 0;
        });
    }
</script>
</body>
</html>
