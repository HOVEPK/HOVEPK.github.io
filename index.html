<script type="module">
import * as THREE from 'three';
import { Sky } from 'three/addons/objects/Sky.js';
import { Water } from 'three/addons/objects/Water.js';
import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

const scene = new THREE.Scene();
scene.fog = new THREE.FogExp2(0x88ccee, 0.0009);

const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 15000);
camera.position.set(0, 20, 200);
camera.rotation.order = "YXZ";

const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setSize(innerWidth, innerHeight);
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
renderer.physicallyCorrectLights = true;
renderer.outputColorSpace = THREE.SRGBColorSpace;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.2;
document.body.appendChild(renderer.domElement);

const composer = new EffectComposer(renderer);
composer.addPass(new RenderPass(scene,camera));
composer.addPass(new UnrealBloomPass(
    new THREE.Vector2(innerWidth,innerHeight),
    0.6,0.4,0.85
));

// HDR
new RGBELoader()
.setPath('https://dl.polyhaven.org/file/ph-assets/HDRIs/hdr/1k/')
.load('venice_sunset_1k.hdr', tex=>{
    tex.mapping = THREE.EquirectangularReflectionMapping;
    scene.environment = tex;
});

// Свет
scene.add(new THREE.HemisphereLight(0xffffff,0x444444,1.2));
const sun = new THREE.DirectionalLight(0xffffff,2);
sun.position.set(200,500,100);
sun.castShadow = true;
sun.shadow.mapSize.set(2048,2048);
scene.add(sun);

// Небо
const sky = new Sky();
sky.scale.setScalar(10000);
scene.add(sky);

const sunPos = new THREE.Vector3();
sunPos.setFromSphericalCoords(1,THREE.MathUtils.degToRad(82),THREE.MathUtils.degToRad(170));
sky.material.uniforms['sunPosition'].value.copy(sunPos);

// Вода
const water = new Water(
    new THREE.PlaneGeometry(10000,10000,256,256),
    {
        textureWidth:512,
        textureHeight:512,
        waterNormals:new THREE.TextureLoader().load(
            'https://threejs.org/examples/textures/waternormals.jpg',
            t=>{t.wrapS=t.wrapT=THREE.RepeatWrapping;}
        ),
        sunDirection:sunPos,
        sunColor:0xffffff,
        waterColor:0x004466,
        distortionScale:4
    }
);
water.rotation.x = -Math.PI/2;
water.position.y = -5;
scene.add(water);

// Остров
const island = new THREE.Mesh(
    new THREE.CylinderGeometry(450,480,25,64),
    new THREE.MeshStandardMaterial({ color:0x5a7a3a, roughness:0.9 })
);
island.position.y = -10;
scene.add(island);

// ---------- МОБИЛЬНОЕ УПРАВЛЕНИЕ ----------

let move = { active:false, id:null, startX:0, startY:0, x:0, y:0 };
let look = { active:false, id:null, lastX:0, lastY:0 };
let rotation = { yaw:0, pitch:0 };

const joyUI = document.getElementById("joy-ui");
const knob = document.getElementById("joy-knob");

window.addEventListener("pointerdown", e=>{
    if(e.clientX < innerWidth/2){
        move.active = true;
        move.id = e.pointerId;
        move.startX = e.clientX;
        move.startY = e.clientY;

        joyUI.style.display = "block";
        joyUI.style.left = (e.clientX - 50) + "px";
        joyUI.style.top = (e.clientY - 50) + "px";
    } else {
        look.active = true;
        look.id = e.pointerId;
        look.lastX = e.clientX;
        look.lastY = e.clientY;
    }
});

window.addEventListener("pointermove", e=>{
    if(e.pointerId === move.id){
        let dx = e.clientX - move.startX;
        let dy = e.clientY - move.startY;

        let dist = Math.min(Math.sqrt(dx*dx+dy*dy), 40);
        let angle = Math.atan2(dy, dx);

        move.x = Math.cos(angle) * (dist/40);
        move.y = Math.sin(angle) * (dist/40);

        knob.style.transform =
            `translate(${Math.cos(angle)*dist}px,${Math.sin(angle)*dist}px)`;
    }

    if(e.pointerId === look.id){
        rotation.yaw -= (e.clientX - look.lastX) * 0.005;
        rotation.pitch -= (e.clientY - look.lastY) * 0.005;

        rotation.pitch = Math.max(-1.4, Math.min(1.4, rotation.pitch));

        look.lastX = e.clientX;
        look.lastY = e.clientY;
    }
});

window.addEventListener("pointerup", e=>{
    if(e.pointerId === move.id){
        move.active = false;
        move.x = 0;
        move.y = 0;
        joyUI.style.display = "none";
        knob.style.transform = "translate(0px,0px)";
    }
    if(e.pointerId === look.id){
        look.active = false;
    }
});

// ---------- АНИМАЦИЯ ----------

function animate(){
    requestAnimationFrame(animate);

    // движение
    if(move.active){
        const forward = new THREE.Vector3(0,0,-1)
            .applyQuaternion(camera.quaternion)
            .setY(0)
            .normalize();

        const right = new THREE.Vector3(1,0,0)
            .applyQuaternion(camera.quaternion)
            .setY(0)
            .normalize();

        camera.position.addScaledVector(forward, -move.y * 3);
        camera.position.addScaledVector(right, move.x * 3);

        // граница острова
        if(camera.position.length() > 450){
            camera.position.setLength(450);
        }
    }

    // вращение камеры
    camera.rotation.y = rotation.yaw;
    camera.rotation.x = rotation.pitch;

    water.material.uniforms["time"].value += 0.01;

    composer.render();
}

animate();

</script>
