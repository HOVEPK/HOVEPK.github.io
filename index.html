<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Epstein Island: Ultra Realistic</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; font-family: 'Segoe UI', sans-serif; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #sound-panel {
            position: absolute; top: 20px; right: 20px; z-index: 1000; pointer-events: auto;
            background: rgba(0,0,0,0.85); padding: 10px; border-radius: 12px; border: 1px solid #ffaa00;
        }
        #temple-player { display: none; }
        #joy-base {
            position: absolute; width: 130px; height: 130px;
            background: rgba(255,255,255,0.03); border: 2px solid rgba(255,255,255,0.1);
            border-radius: 50%; display: none; pointer-events: none; z-index: 100; backdrop-filter: blur(5px);
        }
        #joy-stick { position: absolute; width: 55px; height: 55px; background: #fff; border-radius: 50%; top: 37.5px; left: 37.5px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="sound-panel">
            <div id="world-player"><iframe width="110" height="70" src="https://www.myinstants.com/instant/jeffrey-epstein-edit-98984/embed/" frameborder="0" scrolling="no"></iframe></div>
            <div id="temple-player"><iframe width="110" height="70" src="https://www.myinstants.com/instant/lock-in-epstein-edition-slowed-64683/embed/" frameborder="0" scrolling="no"></iframe></div>
        </div>
    </div>

    <div id="joy-base"><div id="joy-stick"></div></div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { Sky } from 'three/addons/objects/Sky.js';
        import { Water } from 'three/addons/objects/Water.js';

        // --- ИНИЦИАЛИЗАЦИЯ ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0xaabbcc, 0.0004);
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 10000);
        camera.position.set(350, 80, 350);
        camera.rotation.order = 'YXZ';

        const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.2;
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.body.appendChild(renderer.domElement);

        // --- СВЕТ ---
        const ambient = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambient);

        const sunLight = new THREE.DirectionalLight(0xfff5e1, 3.0);
        sunLight.position.set(300, 500, 200);
        sunLight.castShadow = true;
        sunLight.shadow.mapSize.set(4096, 4096);
        sunLight.shadow.camera.left = -1000; sunLight.shadow.camera.right = 1000;
        sunLight.shadow.camera.top = 1000; sunLight.shadow.camera.bottom = -1000;
        scene.add(sunLight);

        // --- ОКРУЖЕНИЕ ---
        const sun = new THREE.Vector3();
        const sky = new Sky(); sky.scale.setScalar(10000); scene.add(sky);
        sun.setFromSphericalCoords(1, THREE.MathUtils.degToRad(82), THREE.MathUtils.degToRad(160));
        sky.material.uniforms['sunPosition'].value.copy(sun);

        const water = new Water(new THREE.PlaneGeometry(15000, 15000), {
            textureWidth: 1024, textureHeight: 1024,
            waterNormals: new THREE.TextureLoader().load('https://threejs.org/examples/textures/waternormals.jpg', t => t.wrapS = t.wrapT = THREE.RepeatWrapping),
            sunDirection: sun, sunColor: 0xffffff, waterColor: 0x001e22, distortionScale: 5.0
        });
        water.rotation.x = -Math.PI / 2; water.position.y = -5; scene.add(water);

        // --- РЕАЛИСТИЧНЫЙ ЛАНДШАФТ ---
        const islandRadius = 600;
        const terrainGeo = new THREE.PlaneGeometry(islandRadius * 2, islandRadius * 2, 256, 256);
        terrainGeo.rotateX(-Math.PI / 2);

        const posAttr = terrainGeo.attributes.position;
        for (let i = 0; i < posAttr.count; i++) {
            let x = posAttr.getX(i), z = posAttr.getZ(i);
            let d = Math.sqrt(x*x + z*z);
            let h = 0;
            if (d < islandRadius) {
                h = Math.sin(x * 0.01) * Math.cos(z * 0.01) * 25; // Холмы
                h += Math.exp(-(d * 0.005)) * 40; // Центр выше
                if (d > islandRadius - 100) h *= (islandRadius - d) / 100; // Плавный спуск к воде
                posAttr.setY(i, h - 10);
            } else { posAttr.setY(i, -30); }
        }
        terrainGeo.computeVertexNormals();
        const terrain = new THREE.Mesh(terrainGeo, new THREE.MeshStandardMaterial({ color: 0xc2b280, roughness: 1 }));
        terrain.receiveShadow = true;
        scene.add(terrain);

        // --- ХРАМ В ТОЧЬ-В-ТОЧЬ (Epstein Temple) ---
        const temple = new THREE.Group();
        const tW = 120; // Ширина
        const tH = 80;  // Высота

        // Стены с синими полосами
        for(let i=0; i<10; i++) {
            const mat = new THREE.MeshStandardMaterial({ color: i % 2 === 0 ? 0x0044bb : 0xffffff, roughness: 0.3 });
            const stripe = (w, d, px, pz, y) => {
                const m = new THREE.Mesh(new THREE.BoxGeometry(w, 8, d), mat);
                m.position.set(px, y, pz); m.castShadow = true; temple.add(m);
            };
            const hOffset = i * 8 + 4;
            stripe(tW, 5, 0, -tW/2, hOffset); stripe(5, tW, -tW/2, 0, hOffset); stripe(5, tW, tW/2, 0, hOffset);
            if (i > 5) stripe(tW, 5, 0, tW/2, hOffset); // Верх входа
            else { stripe(35, 5, -42.5, tW/2, hOffset); stripe(35, 5, 42.5, tW/2, hOffset); } // Проем
        }

        // Золотой купол (Ultra Reflective)
        const dome = new THREE.Mesh(
            new THREE.SphereGeometry(tW/2.1, 64, 32, 0, Math.PI*2, 0, Math.PI/2),
            new THREE.MeshStandardMaterial({ color: 0xffcc00, metalness: 1, roughness: 0.1 })
        );
        dome.position.y = 80; temple.add(dome);

        // Красный лабиринт на полу
        const maze = new THREE.Mesh(new THREE.PlaneGeometry(250, 250), new THREE.MeshStandardMaterial({ color: 0xaa2222, roughness: 0.8 }));
        maze.rotation.x = -Math.PI/2; maze.position.set(0, 1, 150); scene.add(maze);

        temple.position.y = 15; scene.add(temple);

        // --- ПАЛЬМЫ И ВЕТЕР ---
        const leafMat = new THREE.MeshStandardMaterial({ color: 0x225511, side: THREE.DoubleSide });
        leafMat.onBeforeCompile = (sh) => {
            sh.uniforms.uTime = { value: 0 };
            sh.vertexShader = `uniform float uTime;\n` + sh.vertexShader.replace(`#include <begin_vertex>`, 
                `vec3 v = position; float w = sin(uTime * 2.0 + v.x * 0.5) * pow(uv.y, 2.5) * 3.0; v.y += w; vec3 transformed = v;`);
            leafMat.userData.shader = sh;
        };

        function spawnPalm(x, z) {
            const p = new THREE.Group();
            const h = 70 + Math.random()*30;
            const trunk = new THREE.Mesh(new THREE.CylinderGeometry(1.5, 3, h, 12), new THREE.MeshStandardMaterial({color: 0x443322}));
            trunk.position.y = h/2; trunk.rotation.z = (Math.random()-0.5)*0.2; p.add(trunk);
            for(let i=0; i<15; i++) {
                const leaf = new THREE.Mesh(new THREE.PlaneGeometry(30, 5, 10, 1), leafMat);
                leaf.position.y = h; leaf.rotation.y = i*Math.PI/7.5; leaf.rotation.z = 0.8; leaf.translateX(15); p.add(leaf);
            }
            p.position.set(x, 25, z); p.castShadow = true; scene.add(p);
        }
        for(let i=0; i<40; i++) {
            let a = Math.random()*Math.PI*2, r = 200 + Math.random()*300;
            spawnPalm(Math.cos(a)*r, Math.sin(a)*r);
        }

        // --- УПРАВЛЕНИЕ ---
        let joyId = null, lookId = null, move = { x: 0, y: 0, startX: 0, startY: 0 }, rot = { yaw: 0, pitch: 0 }, lastL = { x: 0, y: 0 };
        const jB = document.getElementById('joy-base'), jS = document.getElementById('joy-stick');

        window.addEventListener('pointerdown', e => {
            if (e.clientX < window.innerWidth/2) { joyId = e.pointerId; move.startX = e.clientX; move.startY = e.clientY; jB.style.display = 'block'; jB.style.left = (e.clientX-65)+'px'; jB.style.top = (e.clientY-65)+'px'; }
            else { lookId = e.pointerId; lastL.x = e.clientX; lastL.y = e.clientY; }
        });
        window.addEventListener('pointermove', e => {
            if (e.pointerId === joyId) {
                let dx = e.clientX - move.startX, dy = e.clientY - move.startY, d = Math.min(Math.sqrt(dx*dx+dy*dy), 50), a = Math.atan2(dy, dx);
                move.x = Math.cos(a)*(d/50); move.y = Math.sin(a)*(d/50); jS.style.transform = `translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
            } else if (e.pointerId === lookId) {
                rot.yaw -= (e.clientX - lastL.x)*0.005; rot.pitch = Math.max(-1.5, Math.min(1.5, rot.pitch - (e.clientY - lastL.y)*0.005));
                lastL.x = e.clientX; lastL.y = e.clientY;
            }
        });
        window.addEventListener('pointerup', () => { joyId = null; move.x = 0; move.y = 0; jB.style.display = 'none'; lookId = null; });

        // --- ЦИКЛ РЕНДЕРА ---
        const clock = new THREE.Clock();
        const worldUI = document.getElementById('world-player'), templeUI = document.getElementById('temple-player');
        let isInside = false;

        function animate() {
            requestAnimationFrame(animate);
            const t = clock.getElapsedTime();
            if (leafMat.userData.shader) leafMat.userData.shader.uniforms.uTime.value = t;

            if (joyId !== null) {
                const f = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion); f.y = 0; f.normalize();
                const r = new THREE.Vector3(1,0,0).applyQuaternion(camera.quaternion); r.y = 0; r.normalize();
                camera.position.addScaledVector(f, -move.y * 3.5); camera.position.addScaledVector(r, move.x * 3.5);

                const d = camera.position.length();
                if (d < 60 && !isInside) { camera.position.set(0, 35, 0); isInside = true; worldUI.style.display = 'none'; templeUI.style.display = 'block'; }
                else if (d > 100 && isInside) { isInside = false; worldUI.style.display = 'block'; templeUI.style.display = 'none'; }
            }
            camera.rotation.y = rot.yaw; camera.rotation.x = rot.pitch;
            water.material.uniforms['time'].value += 0.01;
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
