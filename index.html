<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>St. James: True First Person</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; touch-action: none; font-family: sans-serif; }
        #ui { position: absolute; top: 20px; left: 20px; color: white; pointer-events: none; text-shadow: 2px 2px 4px #000; z-index: 100; }
        
        /* Зоны управления */
        #walk-zone { position: absolute; top: 0; left: 0; width: 50%; height: 100%; z-index: 10; }
        #look-zone { position: absolute; top: 0; right: 0; width: 50%; height: 100%; z-index: 10; }
        
        #joy-base { 
            position: absolute; width: 80px; height: 80px; background: rgba(255,255,255,0.1); 
            border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; display: none; transform: translate(-50%, -50%);
        }
        #joy-stick { position: absolute; width: 35px; height: 35px; background: #fff; border-radius: 50%; top: 22.5px; left: 22.5px; opacity: 0.8; }
        #crosshair { position: absolute; top: 50%; left: 50%; width: 6px; height: 6px; background: rgba(255,255,255,0.5); border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; }
    </style>
</head>
<body>

<div id="ui">LITTLE ST. JAMES • FIRST PERSON MODE</div>
<div id="crosshair"></div>
<div id="walk-zone"><div id="joy-base"><div id="joy-stick"></div></div></div>
<div id="look-zone"></div>

<script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
</script>

<script type="module">
    import * as THREE from 'three';
    import { Water } from 'three/addons/objects/Water.js';
    import { Sky } from 'three/addons/objects/Sky.js';

    let scene, camera, renderer, water, clock;
    let moveDir = new THREE.Vector2();
    let lookYaw = 0, lookPitch = 0;
    let bobbingTimer = 0;
    const colliders = [];

    // Контроллеры тача
    let joyBase = document.getElementById('joy-base');
    let moveId = null, lookId = null;
    let lookStart = new THREE.Vector2();

    init();

    function init() {
        scene = new THREE.Scene();
        clock = new THREE.Clock();

        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
        camera.rotation.order = 'YXZ';
        camera.position.set(40, 2, 40);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        document.body.appendChild(renderer.domElement);

        setupEnvironment();
        createIsland();
        setupInput();

        window.addEventListener('resize', onWindowResize);
        animate();
    }

    function setupEnvironment() {
        const sky = new Sky();
        sky.scale.setScalar(450000);
        scene.add(sky);
        const sun = new THREE.Vector3();
        sun.setFromSphericalCoords(1, THREE.MathUtils.degToRad(88), Math.PI);
        sky.material.uniforms['sunPosition'].value.copy(sun);

        scene.add(new THREE.AmbientLight(0xffffff, 0.7));
        const light = new THREE.DirectionalLight(0xffffff, 1.0);
        light.position.set(50, 50, 50);
        scene.add(light);

        water = new Water(new THREE.PlaneGeometry(2000, 2000), {
            textureWidth: 512, textureHeight: 512,
            waterNormals: new THREE.TextureLoader().load('https://threejs.org/examples/textures/waternormals.jpg', t => t.wrapS = t.wrapT = THREE.RepeatWrapping),
            sunDirection: sun, sunColor: 0xffffff, waterColor: 0x003344, distortionScale: 4.0
        });
        water.rotation.x = -Math.PI / 2;
        water.position.y = 0.5;
        scene.add(water);
    }

    function createIsland() {
        // Ландшафт с холмом в центре
        const islandGeo = new THREE.PlaneGeometry(160, 160, 80, 80);
        const pos = islandGeo.attributes.position;
        for (let i = 0; i < pos.count; i++) {
            let x = pos.getX(i), y = pos.getY(i);
            let d = Math.sqrt(x*x + y*y);
            let h = Math.max(0, (40 - d) * 0.4) + Math.sin(x*0.2) * Math.cos(y*0.2) * 1.5;
            if (d > 60) h = -5;
            pos.setZ(i, h);
        }
        islandGeo.computeVertexNormals();
        const islandMat = new THREE.MeshStandardMaterial({ color: 0xe3c1a1, roughness: 1 });
        const island = new THREE.Mesh(islandGeo, islandMat);
        island.rotation.x = -Math.PI / 2;
        scene.add(island);

        // Тот самый Храм
        createTemple(0, 15, 0);

        // Пальмы
        for(let i = 0; i < 35; i++) {
            let a = Math.random() * Math.PI * 2;
            let r = 20 + Math.random() * 35;
            createPalm(Math.cos(a)*r, Math.sin(a)*r);
        }
    }

    function createTemple(x, y, z) {
        const temple = new THREE.Group();
        for(let i = 0; i < 20; i++) {
            const stripe = new THREE.Mesh(
                new THREE.BoxGeometry(10, 0.4, 10),
                new THREE.MeshStandardMaterial({ color: i % 2 === 0 ? 0xffffff : 0x0044ff })
            );
            stripe.position.y = i * 0.4;
            temple.add(stripe);
        }
        const dome = new THREE.Mesh(new THREE.SphereGeometry(4, 32, 16, 0, 6.3, 0, 1.6), new THREE.MeshStandardMaterial({color: 0xffd700, metalness: 0.9}));
        dome.position.y = 8;
        temple.add(dome);
        temple.position.set(x, y, z);
        scene.add(temple);
        colliders.push({ x: x, z: z, r: 7 });
    }

    function createPalm(x, z) {
        const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.15, 0.25, 6), new THREE.MeshStandardMaterial({color: 0x5d4037}));
        trunk.position.set(x, 3, z);
        scene.add(trunk);
        const leaves = new THREE.Mesh(new THREE.SphereGeometry(2.5, 8, 4), new THREE.MeshStandardMaterial({color: 0x228b22}));
        leaves.position.set(x, 6, z);
        leaves.scale.y = 0.2;
        scene.add(leaves);
        colliders.push({ x: x, z: z, r: 0.8 });
    }

    function setupInput() {
        const walkZone = document.getElementById('walk-zone');
        const lookZone = document.getElementById('look-zone');

        walkZone.addEventListener('touchstart', e => {
            let t = e.changedTouches[0];
            moveId = t.identifier;
            joyBase.style.display = 'block';
            joyBase.style.left = t.clientX + 'px';
            joyBase.style.top = t.clientY + 'px';
        });

        lookZone.addEventListener('touchstart', e => {
            let t = e.changedTouches[0];
            lookId = t.identifier;
            lookStart.set(t.clientX, t.clientY);
        });

        window.addEventListener('touchmove', e => {
            for(let t of e.changedTouches) {
                if(t.identifier === moveId) {
                    let dx = t.clientX - parseFloat(joyBase.style.left);
                    let dy = t.clientY - parseFloat(joyBase.style.top);
                    let dist = Math.min(Math.sqrt(dx*dx+dy*dy), 35);
                    let angle = Math.atan2(dy, dx);
                    document.getElementById('joy-stick').style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
                    moveDir.set(Math.cos(angle) * (dist/35), -Math.sin(angle) * (dist/35));
                }
                if(t.identifier === lookId) {
                    lookYaw -= (t.clientX - lookStart.x) * 0.007;
                    lookPitch -= (t.clientY - lookStart.y) * 0.007;
                    lookPitch = Math.max(-1.4, Math.min(1.4, lookPitch));
                    lookStart.set(t.clientX, t.clientY);
                }
            }
        }, {passive: false});

        window.addEventListener('touchend', e => {
            for(let t of e.changedTouches) {
                if(t.identifier === moveId) { moveId = null; joyBase.style.display = 'none'; moveDir.set(0,0); }
                if(t.identifier === lookId) lookId = null;
            }
        });
    }

    function animate() {
        requestAnimationFrame(animate);
        const dt = clock.getDelta();

        camera.rotation.set(lookPitch, lookYaw, 0);

        const dir = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
        dir.y = 0; dir.normalize();
        const side = new THREE.Vector3().crossVectors(new THREE.Vector3(0,1,0), dir).normalize();

        const speed = 12 * dt;
        const nextPos = camera.position.clone();
        nextPos.addScaledVector(dir, moveDir.y * speed);
        nextPos.addScaledVector(side, moveDir.x * speed);

        // Коллизии
        let canMove = true;
        colliders.forEach(c => {
            if (Math.sqrt((nextPos.x - c.x)**2 + (nextPos.z - c.z)**2) < c.r) canMove = false;
        });

        if (canMove && Math.sqrt(nextPos.x**2 + nextPos.z**2) < 65) {
            camera.position.copy(nextPos);
        }

        // Эффект покачивания и высота ландшафта
        if (moveDir.length() > 0.1) {
            bobbingTimer += dt * 10;
            camera.position.y = (1.7 + Math.sin(bobbingTimer) * 0.05) + Math.max(0, (40 - Math.sqrt(camera.position.x**2 + camera.position.z**2)) * 0.4);
        }

        water.material.uniforms['time'].value += dt;
        renderer.render(scene, camera);
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }
</script>
</body>
</html>
