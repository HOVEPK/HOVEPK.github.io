<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>St. James: Definitive Realism</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; touch-action: none; font-family: 'Segoe UI', sans-serif; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        /* Статический Джойстик */
        #joy-base { 
            position: absolute; bottom: 50px; left: 50px; width: 100px; height: 100px; 
            background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.2); 
            border-radius: 50%; pointer-events: auto; backdrop-filter: blur(5px);
        }
        #joy-stick { 
            position: absolute; width: 40px; height: 40px; background: #fff; 
            border-radius: 50%; top: 30px; left: 30px; box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        
        #hint { position: absolute; top: 20px; width: 100%; text-align: center; color: white; font-size: 12px; letter-spacing: 2px; opacity: 0.6; }
    </style>
</head>
<body>

<div id="ui-layer">
    <div id="hint">КЛИКНИТЕ ДЛЯ АКТИВАЦИИ ЗВУКА И УПРАВЛЕНИЯ</div>
    <div id="joy-base"><div id="joy-stick"></div></div>
</div>

<script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
</script>

<script type="module">
    import * as THREE from 'three';
    import { Water } from 'three/addons/objects/Water.js';
    import { Sky } from 'three/addons/objects/Sky.js';

    let scene, camera, renderer, water, clock;
    let moveDir = new THREE.Vector2();
    let yaw = 0, pitch = 0;
    let audioInited = false;
    const colliders = [];

    // Для управления взглядом
    let isTouchingLook = false;
    let lastTouchX = 0, lastTouchY = 0;

    init();

    function init() {
        scene = new THREE.Scene();
        clock = new THREE.Clock();

        camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 2000);
        camera.rotation.order = 'YXZ';
        camera.position.set(50, 5, 50);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        document.body.appendChild(renderer.domElement);

        setupScene();
        createProIsland();
        setupControls();

        window.addEventListener('resize', onWindowResize);
        animate();
    }

    function setupScene() {
        const sky = new Sky();
        sky.scale.setScalar(450000);
        scene.add(sky);
        const sun = new THREE.Vector3();
        sun.setFromSphericalCoords(1, THREE.MathUtils.degToRad(87), Math.PI * 1.2);
        sky.material.uniforms['sunPosition'].value.copy(sun);

        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        const light = new THREE.DirectionalLight(0xffffff, 1.5);
        light.position.set(50, 100, 50);
        light.castShadow = true;
        scene.add(light);

        water = new Water(new THREE.PlaneGeometry(3000, 3000), {
            textureWidth: 512, textureHeight: 512,
            waterNormals: new THREE.TextureLoader().load('https://threejs.org/examples/textures/waternormals.jpg', t => t.wrapS = t.wrapT = THREE.RepeatWrapping),
            sunDirection: sun, sunColor: 0xffffff, waterColor: 0x002233, distortionScale: 4.0
        });
        water.rotation.x = -Math.PI / 2;
        water.position.y = 0.5;
        scene.add(water);
    }

    function createProIsland() {
        // Улучшенный ландшафт (Heightmap simulation)
        const geo = new THREE.PlaneGeometry(180, 180, 128, 128);
        const pos = geo.attributes.position;
        for (let i = 0; i < pos.count; i++) {
            let x = pos.getX(i), y = pos.getY(i);
            let d = Math.sqrt(x*x + y*y);
            
            // Формируем основной массив острова
            let height = 0;
            if (d < 70) {
                height = (Math.cos(d / 45) * 12) + (Math.sin(x * 0.2) * Math.cos(y * 0.2) * 2.5);
                // Плато для храма
                if (Math.abs(x) < 15 && Math.abs(y) < 15) height = 14 + (Math.random() * 0.2);
            } else {
                height = -5; // Дно океана
            }
            pos.setZ(i, height);
        }
        geo.computeVertexNormals();
        const mesh = new THREE.Mesh(geo, new THREE.MeshStandardMaterial({ color: 0xc2b280, roughness: 0.9 }));
        mesh.rotation.x = -Math.PI / 2;
        scene.add(mesh);

        // Храм (Сине-белый полосатый)
        const templeGroup = new THREE.Group();
        for(let i = 0; i < 24; i++) {
            const stripe = new THREE.Mesh(
                new THREE.BoxGeometry(10, 0.3, 10),
                new THREE.MeshStandardMaterial({ color: i % 2 === 0 ? 0xffffff : 0x0033cc })
            );
            stripe.position.y = i * 0.3;
            templeGroup.add(stripe);
        }
        const dome = new THREE.Mesh(new THREE.SphereGeometry(4, 32, 16, 0, 6.3, 0, 1.6), new THREE.MeshStandardMaterial({color: 0xffd700, metalness: 1, roughness: 0.1}));
        dome.position.y = 7.2;
        templeGroup.add(dome);
        templeGroup.position.set(0, 14, 0);
        scene.add(templeGroup);
        colliders.push({ x: 0, z: 0, r: 7 });

        // Реалистичные пальмы
        for(let i = 0; i < 30; i++) {
            let a = Math.random() * Math.PI * 2;
            let r = 25 + Math.random() * 40;
            spawnPalm(Math.cos(a)*r, Math.sin(a)*r);
        }
    }

    function spawnPalm(x, z) {
        const h = 6 + Math.random() * 3;
        const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.3, h), new THREE.MeshStandardMaterial({color: 0x4b3621}));
        trunk.position.set(x, h/2 + 2, z);
        scene.add(trunk);
        const leaves = new THREE.Mesh(new THREE.SphereGeometry(3, 8, 4), new THREE.MeshStandardMaterial({color: 0x1a4a1a}));
        leaves.position.set(x, h + 2, z);
        leaves.scale.y = 0.1;
        scene.add(leaves);
        colliders.push({ x: x, z: z, r: 1 });
    }

    function setupControls() {
        const base = document.getElementById('joy-base');
        const stick = document.getElementById('joy-stick');

        base.addEventListener('touchstart', (e) => { e.stopPropagation(); }, {passive: false});
        base.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const t = e.touches[0];
            const r = base.getBoundingClientRect();
            const dx = t.clientX - (r.left + 50);
            const dy = t.clientY - (r.top + 50);
            const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 40);
            const ang = Math.atan2(dy, dx);
            stick.style.transform = `translate(${Math.cos(ang)*dist}px, ${Math.sin(ang)*dist}px)`;
            moveDir.set(Math.cos(ang) * (dist/40), -Math.sin(ang) * (dist/40));
            if(!audioInited) initAudio();
        }, {passive: false});

        base.addEventListener('touchend', () => {
            stick.style.transform = 'translate(0,0)';
            moveDir.set(0,0);
        });

        // Прямое управление взглядом (без инверсии)
        window.addEventListener('touchstart', (e) => {
            if(e.touches[0].clientX > window.innerWidth / 2 || e.touches[0].clientY < window.innerHeight / 2) {
                isTouchingLook = true;
                lastTouchX = e.touches[0].clientX;
                lastTouchY = e.touches[0].clientY;
            }
        });

        window.addEventListener('touchmove', (e) => {
            if(isTouchingLook) {
                const t = e.touches[0];
                const dx = t.clientX - lastTouchX;
                const dy = t.clientY - lastTouchY;
                yaw -= dx * 0.005; // Влево -> камера влево
                pitch -= dy * 0.005;
                pitch = Math.max(-1.4, Math.min(1.4, pitch));
                lastTouchX = t.clientX;
                lastTouchY = t.clientY;
            }
        });

        window.addEventListener('touchend', () => { isTouchingLook = false; });
    }

    function initAudio() {
        audioInited = true;
        document.getElementById('hint').style.display = 'none';
        // Здесь можно добавить реальные аудио-файлы через AudioContext
    }

    function animate() {
        requestAnimationFrame(animate);
        const dt = clock.getDelta();

        camera.rotation.set(pitch, yaw, 0);

        const dir = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
        dir.y = 0; dir.normalize();
        const side = new THREE.Vector3().crossVectors(new THREE.Vector3(0,1,0), dir).normalize();

        const speed = 15 * dt;
        const nextPos = camera.position.clone();
        nextPos.addScaledVector(dir, moveDir.y * speed);
        nextPos.addScaledVector(side, moveDir.x * speed);

        // Умная коллизия
        let canMove = true;
        colliders.forEach(c => {
            const dist = Math.sqrt((nextPos.x - c.x)**2 + (nextPos.z - c.z)**2);
            if(dist < c.r) canMove = false;
        });

        if(canMove && Math.sqrt(nextPos.x**2 + nextPos.z**2) < 75) {
            camera.position.copy(nextPos);
        }

        // Высота ходьбы
        let distCenter = Math.sqrt(camera.position.x**2 + camera.position.z**2);
        let terrainHeight = Math.max(0.5, (Math.cos(distCenter / 45) * 12) + 1.7);
        camera.position.y = THREE.MathUtils.lerp(camera.position.y, terrainHeight, 0.1);

        water.material.uniforms['time'].value += dt;
        renderer.render(scene, camera);
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }
</script>
</body>
</html>
