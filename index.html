<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>St. James Ultra 3D</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Inter', sans-serif; }
        
        /* Анимированный джойстик */
        #joy-container {
            position: absolute; bottom: 50px; left: 50px;
            width: 140px; height: 140px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%; backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center;
            transition: border-color 0.3s; touch-action: none;
        }
        #joy-knob {
            width: 60px; height: 60px;
            background: radial-gradient(circle, #fff 0%, #ccc 100%);
            border-radius: 50%; box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            transition: transform 0.1s ease-out;
        }
        #joy-container:active { border-color: #007bff; }

        #ui {
            position: absolute; top: 30px; left: 30px; color: white;
            pointer-events: none; text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .instruction { font-size: 12px; opacity: 0.6; margin-top: 5px; }
    </style>
</head>
<body>

<div id="ui">
    <div style="font-size: 24px; letter-spacing: 2px;">LITTLE ST. JAMES</div>
    <div class="instruction">WASD или Джойстик для прогулки</div>
</div>

<div id="joy-container"><div id="joy-knob"></div></div>

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
</script>

<script type="module">
    import * as THREE from 'three';
    import { Sky } from 'three/addons/objects/Sky.js';
    import { Water } from 'three/addons/objects/Water.js';

    let scene, camera, renderer, water, sun;
    let moveForward = 0, moveSide = 0;
    const clock = new THREE.Clock();
    const player = { height: 1.7, radius: 0.5 };

    init();

    function init() {
        scene = new THREE.Scene();
        
        // --- КАМЕРА ---
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
        camera.position.set(20, player.height, 20);

        // --- РЕНДЕРИНГ ---
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.body.appendChild(renderer.domElement);

        // --- НЕБО И СОЛНЦЕ ---
        sun = new THREE.Vector3();
        const sky = new Sky();
        sky.scale.setScalar(450000);
        scene.add(sky);

        const effectController = { turbidity: 10, rayleigh: 3, mieCoefficient: 0.005, mieDirectionalG: 0.7, elevation: 5, azimuth: 180 };
        const uniforms = sky.material.uniforms;
        uniforms['turbidity'].value = effectController.turbidity;
        uniforms['rayleigh'].value = effectController.rayleigh;
        uniforms['mieCoefficient'].value = effectController.mieCoefficient;
        uniforms['mieDirectionalG'].value = effectController.mieDirectionalG;

        const phi = THREE.MathUtils.degToRad(90 - effectController.elevation);
        const theta = THREE.MathUtils.degToRad(effectController.azimuth);
        sun.setFromSphericalCoords(1, phi, theta);
        uniforms['sunPosition'].value.copy(sun);

        // --- ВОДА ---
        const waterGeometry = new THREE.PlaneGeometry(10000, 10000);
        water = new Water(waterGeometry, {
            textureWidth: 512, textureHeight: 512,
            waterNormals: new THREE.TextureLoader().load('https://threejs.org/examples/textures/waternormals.jpg', function(t) {
                t.wrapS = t.wrapT = THREE.RepeatWrapping;
            }),
            sunDirection: sun,
            sunColor: 0xffffff,
            waterColor: 0x001e0f,
            distortionScale: 3.7,
            fog: scene.fog !== undefined
        });
        water.rotation.x = -Math.PI / 2;
        scene.add(water);

        // --- ОСТРОВ ---
        const islandGeo = new THREE.CylinderGeometry(50, 55, 5, 64);
        const islandMat = new THREE.MeshStandardMaterial({ color: 0xedc9af, roughness: 1 });
        const island = new THREE.Mesh(islandGeo, islandMat);
        island.position.y = -2.5;
        island.receiveShadow = true;
        scene.add(island);

        // --- ЗДАНИЕ (ДЕТАЛИЗИРОВАННОЕ) ---
        createTemple();

        // --- УПРАВЛЕНИЕ ---
        setupMobileJoystick();
        window.addEventListener('keydown', (e) => {
            if(e.code === 'KeyW') moveForward = 1;
            if(e.code === 'KeyS') moveForward = -1;
            if(e.code === 'KeyA') moveSide = -1;
            if(e.code === 'KeyD') moveSide = 1;
        });
        window.addEventListener('keyup', (e) => {
            if(['KeyW', 'KeyS'].includes(e.code)) moveForward = 0;
            if(['KeyA', 'KeyD'].includes(e.code)) moveSide = 0;
        });

        animate();
    }

    function createTemple() {
        const group = new THREE.Group();
        // Полосатый фасад (высокая детализация)
        for (let i = 0; i < 15; i++) {
            const h = 0.3;
            const box = new THREE.Mesh(
                new THREE.BoxGeometry(10, h, 10),
                new THREE.MeshStandardMaterial({ color: i % 2 === 0 ? 0xffffff : 0x0055ff, metalness: 0.1, roughness: 0.5 })
            );
            box.position.y = i * h;
            box.castShadow = true;
            box.receiveShadow = true;
            group.add(box);
        }
        
        // Золотой купол
        const dome = new THREE.Mesh(
            new THREE.SphereGeometry(3, 32, 16, 0, Math.PI * 2, 0, Math.PI / 2),
            new THREE.MeshStandardMaterial({ color: 0xffd700, metalness: 0.9, roughness: 0.1 })
        );
        dome.position.y = 15 * 0.3;
        group.add(dome);

        group.position.set(0, 0, 0);
        scene.add(group);
    }

    function setupMobileJoystick() {
        const container = document.getElementById('joy-container');
        const knob = document.getElementById('joy-knob');
        
        container.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = container.getBoundingClientRect();
            const x = touch.clientX - (rect.left + 70);
            const y = touch.clientY - (rect.top + 70);
            const dist = Math.sqrt(x*x + y*y);
            const max = 50;
            
            const limitedX = x * (Math.min(dist, max) / dist);
            const limitedY = y * (Math.min(dist, max) / dist);
            
            knob.style.transform = `translate(${limitedX}px, ${limitedY}px)`;
            moveSide = limitedX / max;
            moveForward = -limitedY / max;
        });

        container.addEventListener('touchend', () => {
            knob.style.transform = `translate(0, 0)`;
            moveForward = moveSide = 0;
        });
    }

    function animate() {
        requestAnimationFrame(animate);
        const delta = clock.getDelta();
        
        // Движение с простой коллизией (не входить в центр здания)
        const speed = 8 * delta;
        const nextX = camera.position.x + (moveSide * speed);
        const nextZ = camera.position.z - (moveForward * speed);
        
        const distToCenter = Math.sqrt(nextX**2 + nextZ**2);
        
        // Коллизия со стенами здания (радиус 6 метров) и краем острова (45 метров)
        if (distToCenter > 6 && distToCenter < 45) {
            camera.position.x = nextX;
            camera.position.z = nextZ;
        }

        // Анимация воды
        water.material.uniforms[ 'time' ].value += 1.0 / 60.0;
        
        renderer.render(scene, camera);
    }
</script>
</body>
</html>
