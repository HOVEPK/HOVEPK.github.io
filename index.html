<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Roblox Island: Auto Music</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; font-family: 'Segoe UI', sans-serif; }
        canvas { display: block; }
        
        /* Кнопка запуску */
        #ui-overlay {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
        }
        #start-btn {
            background: #00ff44; border: 2px solid #fff; color: #000;
            padding: 15px 25px; border-radius: 12px; font-weight: bold;
            cursor: pointer; box-shadow: 0 0 20px rgba(0,255,68,0.5);
            text-transform: uppercase; letter-spacing: 1px;
        }

        #joy-base {
            position: absolute; width: 100px; height: 100px;
            background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%; display: none; pointer-events: none; z-index: 100;
        }
        #joy-stick {
            position: absolute; width: 40px; height: 40px;
            background: #fff; border-radius: 50%; top: 30px; left: 30px;
        }
    </style>
</head>
<body>

    <div id="ui-overlay">
        <button id="start-btn">УВІМКНУТИ ЗВУК ТА ГРУ</button>
    </div>

    <div id="joy-base"><div id="joy-stick"></div></div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { Sky } from 'three/addons/objects/Sky.js';
        import { Water } from 'three/addons/objects/Water.js';

        // --- AUDIO SYSTEM ---
        // Прямі посилання на аудіо-потоки
        const worldMusic = new Audio('https://www.myinstants.com/media/sounds/jeffrey-epstein-edit-98984.mp3');
        const templeMusic = new Audio('https://www.myinstants.com/media/sounds/lock-in-epstein-edition-slowed-64683.mp3');
        
        worldMusic.loop = true;
        templeMusic.loop = true;
        worldMusic.crossOrigin = "anonymous";
        templeMusic.crossOrigin = "anonymous";

        let musicPlaying = false;
        let isInside = false;

        const startBtn = document.getElementById('start-btn');
        startBtn.onclick = () => {
            if (!musicPlaying) {
                worldMusic.play().catch(e => console.log("Audio play error:", e));
                templeMusic.play().catch(e => console.log("Audio play error:", e));
                // Відразу ставимо музику храму на беззвучний
                templeMusic.volume = 0;
                worldMusic.volume = 0.6;
                
                startBtn.innerText = "ЗВУК ПРАЦЮЄ";
                startBtn.style.background = "#fff";
                musicPlaying = true;
                
                // Ховаємо кнопку через секунду
                setTimeout(() => { startBtn.style.display = 'none'; }, 1000);
            }
        };

        // --- THREE.JS SCENE ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
        camera.position.set(80, 5, 80);
        camera.rotation.order = 'YXZ';

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.body.appendChild(renderer.domElement);

        // --- ENVIRONMENT ---
        scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1.5));
        const sun = new THREE.Vector3();
        const sky = new Sky(); sky.scale.setScalar(10000); scene.add(sky);
        sun.setFromSphericalCoords(1, THREE.MathUtils.degToRad(88), THREE.MathUtils.degToRad(180));
        sky.material.uniforms['sunPosition'].value.copy(sun);

        const water = new Water(new THREE.PlaneGeometry(4000, 4000), {
            textureWidth: 256, textureHeight: 256,
            waterNormals: new THREE.TextureLoader().load('https://threejs.org/examples/textures/waternormals.jpg', t => t.wrapS = t.wrapT = THREE.RepeatWrapping),
            sunDirection: sun, sunColor: 0xffffff, waterColor: 0x0044ff, distortionScale: 1.5
        });
        water.rotation.x = -Math.PI / 2; water.position.y = -1; scene.add(water);

        const island = new THREE.Mesh(new THREE.CylinderGeometry(140, 150, 10, 32), new THREE.MeshStandardMaterial({ color: 0xeed2af }));
        island.position.y = -5.5; scene.add(island);

        // --- ROBLOX GRASS ---
        const grassCount = 5000;
        const instGrass = new THREE.InstancedMesh(
            new THREE.PlaneGeometry(0.4, 1.0), 
            new THREE.MeshStandardMaterial({ color: 0x22ff22, side: THREE.DoubleSide }), 
            grassCount
        );
        const dummy = new THREE.Object3D();
        for (let i = 0; i < grassCount; i++) {
            const a = Math.random() * Math.PI * 2, r = 35 + Math.random() * 100;
            dummy.position.set(Math.cos(a)*r, -0.4, Math.sin(a)*r);
            dummy.rotation.y = Math.random() * Math.PI;
            dummy.scale.setScalar(0.8 + Math.random() * 0.7);
            dummy.updateMatrix();
            instGrass.setMatrixAt(i, dummy.matrix);
        }
        scene.add(instGrass);

        // --- BIG TEMPLE ---
        const temple = new THREE.Group();
        const wallH = 28, wallW = 45;
        for(let i=0; i<25; i++) {
            const h = wallH/25, y = i*h + h/2, blue = i%2===0;
            const mat = new THREE.MeshStandardMaterial({ color: blue ? 0x0044ff : 0xffffff });
            const box = (w, d, px, pz) => {
                const m = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), mat);
                m.position.set(px, y, pz); temple.add(m);
            };
            box(wallW, 1.5, 0, -wallW/2); box(1.5, wallW, -wallW/2, 0); box(1.5, wallW, wallW/2, 0);
            if(i > 15) box(wallW, 1.5, 0, wallW/2);
            else { box(18, 1.5, -13.5, wallW/2); box(18, 1.5, 13.5, wallW/2); }
        }
        const dome = new THREE.Mesh(new THREE.SphereGeometry(22, 32, 16, 0, Math.PI*2, 0, Math.PI/2), new THREE.MeshStandardMaterial({color: 0xffd700, metalness: 0.9, roughness: 0.1}));
        dome.position.y = wallH; temple.add(dome);
        scene.add(temple);

        // Двері (Телепорт маркер)
        const door = new THREE.Mesh(new THREE.BoxGeometry(9, 16, 0.5), new THREE.MeshStandardMaterial({color: 0x221100}));
        door.position.set(0, 8, wallW/2 + 0.5); scene.add(door);

        // --- CONTROLS ---
        let joyId = null, lookId = null;
        let move = { x: 0, y: 0, startX: 0, startY: 0 };
        let rot = { yaw: 0, pitch: 0 };
        let lastLook = { x: 0, y: 0 };
        const joyB = document.getElementById('joy-base'), joyS = document.getElementById('joy-stick');

        window.addEventListener('pointerdown', e => {
            if (e.clientX < window.innerWidth / 2) {
                joyId = e.pointerId; move.startX = e.clientX; move.startY = e.clientY;
                joyB.style.display = 'block'; joyB.style.left = (e.clientX-50)+'px'; joyB.style.top = (e.clientY-50)+'px';
            } else { lookId = e.pointerId; lastLook.x = e.clientX; lastLook.y = e.clientY; }
        });

        window.addEventListener('pointermove', e => {
            if (e.pointerId === joyId) {
                let dx = e.clientX - move.startX, dy = e.clientY - move.startY;
                let d = Math.min(Math.sqrt(dx*dx+dy*dy), 40), a = Math.atan2(dy, dx);
                move.x = Math.cos(a)*(d/40); move.y = Math.sin(a)*(d/40);
                joyS.style.transform = `translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
            } else if (e.pointerId === lookId) {
                rot.yaw -= (e.clientX - lastLook.x) * 0.007;
                rot.pitch -= (e.clientY - lastLook.y) * 0.007;
                rot.pitch = Math.max(-1.4, Math.min(1.4, rot.pitch));
                lastLook.x = e.clientX; lastLook.y = e.clientY;
            }
        });

        window.addEventListener('pointerup', e => {
            if (e.pointerId === joyId) { joyId = null; move.x = 0; move.y = 0; joyB.style.display = 'none'; }
            else if (e.pointerId === lookId) lookId = null;
        });

        // --- ANIMATION & LOGIC ---
        function animate() {
            requestAnimationFrame(animate);
            if (joyId !== null) {
                const f = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion); f.y = 0; f.normalize();
                const r = new THREE.Vector3(1,0,0).applyQuaternion(camera.quaternion); r.y = 0; r.normalize();
                const old = camera.position.clone();
                camera.position.addScaledVector(f, -move.y * 0.55);
                camera.position.addScaledVector(r, move.x * 0.55);

                // TELEPORT & SOUND CROSSFADE
                const distToDoor = camera.position.distanceTo(new THREE.Vector3(0, 3, wallW/2));
                
                if (distToDoor < 7 && !isInside) {
                    camera.position.set(0, 4, 0); // Телепорт всередину
                    isInside = true;
                    if (musicPlaying) {
                        worldMusic.volume = 0;
                        templeMusic.volume = 0.7;
                    }
                } else if (camera.position.length() > 35 && isInside) {
                    isInside = false; // Вихід
                    if (musicPlaying) {
                        worldMusic.volume = 0.6;
                        templeMusic.volume = 0;
                    }
                }

                // COLLISION
                if (camera.position.length() > 135) camera.position.copy(old);
                if (!isInside && Math.abs(camera.position.x) < wallW/2 + 2 && Math.abs(camera.position.z) < wallW/2 + 2) {
                    if (camera.position.z < wallW/2 - 1) camera.position.copy(old);
                }
            }
            camera.rotation.y = rot.yaw; camera.rotation.x = rot.pitch;
            water.material.uniforms['time'].value += 0.01;
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
