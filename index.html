<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Epstein Island | Ultra Realism</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; font-family: 'Segoe UI', sans-serif; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        /* Плеер */
        #music-panel {
            position: absolute; top: 15px; right: 15px; pointer-events: auto;
            background: rgba(0,0,0,0.8); padding: 10px; border-radius: 15px;
            border: 1px solid #ffcc00; color: white; transition: all 0.5s ease;
        }
        .music-label { font-size: 10px; text-transform: uppercase; color: #ffcc00; margin-bottom: 5px; text-align: center; }
        
        /* Джойстик */
        #joy-base { 
            position: absolute; bottom: 40px; left: 40px; width: 110px; height: 110px; 
            background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); 
            border-radius: 50%; display: none; backdrop-filter: blur(5px);
        }
        #joy-stick { position: absolute; width: 45px; height: 45px; background: #fff; border-radius: 50%; top: 32.5px; left: 32.5px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="music-panel">
            <div class="music-label" id="track-status">Островной режим</div>
            <div id="player-container">
                <iframe id="current-track" width="120" height="70" src="https://www.myinstants.com/instant/jeffrey-epstein-edit-98984/embed/" frameborder="0" scrolling="no"></iframe>
            </div>
        </div>
        <div id="joy-base"><div id="joy-stick"></div></div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { Sky } from 'three/addons/objects/Sky.js';
        import { Water } from 'three/addons/objects/Water.js';

        // --- ИНИЦИАЛИЗАЦИЯ ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0xaaccff, 0.0006);
        const camera = new THREE.PerspectiveCamera(65, window.innerWidth / window.innerHeight, 0.1, 15000);
        camera.position.set(300, 35, 300);
        camera.rotation.order = 'YXZ';

        const renderer = new THREE.WebGLRenderer({ antialias: true, logarithmicDepthBuffer: true });
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.1;
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.body.appendChild(renderer.domElement);

        // --- СВЕТ (Максимальный реализм) ---
        const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1.2);
        scene.add(hemiLight);

        const sunLight = new THREE.DirectionalLight(0xfff5e1, 3.0);
        sunLight.position.set(200, 400, 100);
        sunLight.castShadow = true;
        sunLight.shadow.mapSize.set(2048, 2048);
        sunLight.shadow.camera.left = -500; sunLight.shadow.camera.right = 500;
        sunLight.shadow.camera.top = 500; sunLight.shadow.camera.bottom = -500;
        scene.add(sunLight);

        // --- ОКРУЖЕНИЕ ---
        const sky = new Sky(); sky.scale.setScalar(10000); scene.add(sky);
        const sun = new THREE.Vector3();
        sun.setFromSphericalCoords(1, THREE.MathUtils.degToRad(80), THREE.MathUtils.degToRad(170));
        sky.material.uniforms['sunPosition'].value.copy(sun);

        const water = new Water(new THREE.PlaneGeometry(15000, 15000), {
            textureWidth: 1024, textureHeight: 1024,
            waterNormals: new THREE.TextureLoader().load('https://threejs.org/examples/textures/waternormals.jpg', t => t.wrapS = t.wrapT = THREE.RepeatWrapping),
            sunDirection: sun, sunColor: 0xffffff, waterColor: 0x003355, distortionScale: 4.5
        });
        water.rotation.x = -Math.PI / 2; water.position.y = -5; scene.add(water);

        // --- ОСТРОВ И КОЛЛИЗИЯ ---
        const islandGeo = new THREE.CylinderGeometry(500, 550, 40, 64);
        const islandMat = new THREE.MeshStandardMaterial({ color: 0x4d6622, roughness: 1 });
        const island = new THREE.Mesh(islandGeo, islandMat);
        island.position.y = -10;
        island.receiveShadow = true;
        scene.add(island);

        // Списки для коллизий
        const collidableObjects = [];

        // --- ТРАВА (Instanced Mesh для скорости) ---
        const grassMat = new THREE.MeshStandardMaterial({ color: 0x77aa33, side: THREE.DoubleSide });
        const grassGeo = new THREE.PlaneGeometry(2, 8);
        const instancedGrass = new THREE.InstancedMesh(grassGeo, grassMat, 2500);
        const dummy = new THREE.Object3D();
        for (let i = 0; i < 2500; i++) {
            let angle = Math.random() * Math.PI * 2;
            let radius = Math.random() * 450;
            dummy.position.set(Math.cos(angle)*radius, 10, Math.sin(angle)*radius);
            dummy.rotation.y = Math.random() * Math.PI;
            dummy.updateMatrix();
            instancedGrass.setMatrixAt(i, dummy.matrix);
        }
        scene.add(instancedGrass);

        // --- ХРАМ (С коллизиями) ---
        const temple = new THREE.Group();
        const tW = 100, tH = 80;
        
        const createWall = (w, h, d, x, y, z, mat) => {
            const wall = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), mat);
            wall.position.set(x, y, z); wall.castShadow = true; wall.receiveShadow = true;
            temple.add(wall);
            collidableObjects.push(new THREE.Box3().setFromObject(wall));
        };

        for(let i=0; i<10; i++) {
            const mat = new THREE.MeshStandardMaterial({ color: i % 2 === 0 ? 0x0044cc : 0xffffff });
            const yStripe = i * 8 + 4;
            createWall(tW, 8, 4, 0, yStripe, -tW/2, mat); // Задняя
            createWall(4, 8, tW, -tW/2, yStripe, 0, mat); // Левая
            createWall(4, 8, tW, tW/2, yStripe, 0, mat); // Правая
            if (i > 5) createWall(tW, 8, 4, 0, yStripe, tW/2, mat); // Перед верх
        }

        // Золотой Купол
        const dome = new THREE.Mesh(new THREE.SphereGeometry(tW/2, 32, 32, 0, Math.PI*2, 0, Math.PI/2), 
                     new THREE.MeshStandardMaterial({ color: 0xffaa00, metalness: 1, roughness: 0.1 }));
        dome.position.y = 80; temple.add(dome);
        temple.position.y = 10;
        scene.add(temple);

        // --- ПАЛЬМЫ ---
        function addPalm(x, z) {
            const p = new THREE.Group();
            const trunk = new THREE.Mesh(new THREE.CylinderGeometry(1.5, 3, 70), new THREE.MeshStandardMaterial({color: 0x443322}));
            trunk.position.y = 35; p.add(trunk);
            for(let i=0; i<10; i++) {
                const leaf = new THREE.Mesh(new THREE.PlaneGeometry(35, 6), new THREE.MeshStandardMaterial({color: 0x113300, side: 2}));
                leaf.position.y = 70; leaf.rotation.y = i; leaf.rotation.z = 0.5; leaf.translateX(15); p.add(leaf);
            }
            p.position.set(x, 10, z); scene.add(p);
            collidableObjects.push(new THREE.Box3().setFromObject(trunk));
        }
        for(let i=0; i<30; i++) { addPalm(Math.cos(i)*300, Math.sin(i)*300); }

        // --- УПРАВЛЕНИЕ ---
        let joyId = null, lookId = null, move = { x: 0, y: 0, sX: 0, sY: 0 }, rot = { yaw: 0, pitch: 0 }, lastL = { x: 0, y: 0 };
        const jB = document.getElementById('joy-base'), jS = document.getElementById('joy-stick');

        window.addEventListener('pointerdown', e => {
            if (e.clientX < window.innerWidth/2) {
                joyId = e.pointerId; move.sX = e.clientX; move.sY = e.clientY;
                jB.style.display = 'block'; jB.style.left = (e.clientX-55)+'px'; jB.style.top = (e.clientY-55)+'px';
            } else { lookId = e.pointerId; lastL.x = e.clientX; lastL.y = e.clientY; }
        });

        window.addEventListener('pointermove', e => {
            if (e.pointerId === joyId) {
                let dx = e.clientX - move.sX, dy = e.clientY - move.sY, d = Math.min(Math.sqrt(dx*dx+dy*dy), 45), a = Math.atan2(dy, dx);
                move.x = Math.cos(a)*(d/45); move.y = Math.sin(a)*(d/45);
                jS.style.transform = `translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
            } else if (e.pointerId === lookId) {
                rot.yaw -= (e.clientX - lastL.x)*0.005; rot.pitch = Math.max(-1.4, Math.min(1.4, rot.pitch - (e.clientY - lastL.y)*0.005));
                lastL.x = e.clientX; lastL.y = e.clientY;
            }
        });

        window.addEventListener('pointerup', e => { 
            if(e.pointerId === joyId) { joyId = null; move.x = 0; move.y = 0; jB.style.display = 'none'; }
            if(e.pointerId === lookId) lookId = null;
        });

        // --- ЛОГИКА И ЦИКЛ ---
        const playerBox = new THREE.Box3();
        const playerRadius = 10;
        let inTempleZone = false;

        function animate() {
            requestAnimationFrame(animate);
            
            if (move.x !== 0 || move.y !== 0) {
                const f = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion); f.y = 0; f.normalize();
                const r = new THREE.Vector3(1,0,0).applyQuaternion(camera.quaternion); r.y = 0; r.normalize();
                
                let nextPos = camera.position.clone()
                    .addScaledVector(f, -move.y * 5)
                    .addScaledVector(r, move.x * 5);

                // Коллизии: Проверка границ острова
                const distFromCenter = Math.sqrt(nextPos.x**2 + nextPos.z**2);
                
                // Коллизии: Проверка объектов
                playerBox.setFromCenterAndSize(nextPos, new THREE.Vector3(15, 50, 15));
                let collision = false;
                for(let box of collidableObjects) {
                    if (playerBox.intersectsBox(box)) { collision = true; break; }
                }

                if (!collision && distFromCenter < 480) {
                    camera.position.copy(nextPos);
                }

                // Логика музыки
                if (distFromCenter < 120 && !inTempleZone) {
                    inTempleZone = true;
                    document.getElementById('track-status').innerText = "LOCK IN MODE";
                    document.getElementById('current-track').src = "https://www.myinstants.com/instant/lock-in-epstein-edition-slowed-64683/embed/";
                    document.getElementById('music-panel').style.borderColor = "#0044cc";
                } else if (distFromCenter > 150 && inTempleZone) {
                    inTempleZone = false;
                    document.getElementById('track-status').innerText = "Островной режим";
                    document.getElementById('current-track').src = "https://www.myinstants.com/instant/jeffrey-epstein-edit-98984/embed/";
                    document.getElementById('music-panel').style.borderColor = "#ffcc00";
                }
            }

            camera.rotation.y = rot.yaw; camera.rotation.x = rot.pitch;
            water.material.uniforms['time'].value += 0.01;
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
